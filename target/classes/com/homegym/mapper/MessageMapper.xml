<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<<<<<<< HEAD
<!-- com.homegym.mapper.MessageMapper -->
<mapper namespace="MessageDAO">

	<!-- 임시 : member정보 가져오기 -->
	<select id="getInfo" resultType="member" parameterType="String">
		SELECT *
		FROM member
		WHERE memberId= #{memberId}
	</select>
	<!-- ============= -->

	<!-- 가장 최신 메세지 내용 담긴 리스트 가져오기 -->
	<select id="getMessageAll" resultType="message"
		parameterType="message">
		SELECT MSGNO, MSGROOMNO, SENDID, RECVID,  MSGCONTENT, MSGSENDTIME, MSGREADTIME, MSGCHK 
		FROM MESSAGE
		WHERE MSGNO IN(SELECT MAX(MSGNO)
		FROM MESSAGE GROUP BY MSGROOMNO)
		AND (SENDID = #{curId} OR
		RECVID=#{curId})
		ORDER BY MSGSENDTIME DESC;
	</select>

	<!-- 안읽은 메세지 갯수 가져오기 -->
	<select id="countUnread" parameterType="message"
		resultType="int">
		SELECT COUNT(MSGNO) FROM MESSAGE
		WHERE RECVID=#{curId}
		AND MSGCHK = 0 AND MSGROOMNO = #{msgRoomNo}
	</select>


	<!-- 메세지 list에서 상대방 이미지(프로필사진) 가져오기 -->
	<select id="getOtherImage" parameterType="message"
		resultType="String">
		SELECT IMAGE FROM MEMBER
		<choose>
			<when test="sendId == curId">
				WHERE MEMBERID = #{recvId}
			</when>
			<otherwise>
				WHERE MEMBERID = #{sendId}
			</otherwise>
		</choose>
	</select>

	<!-- 메세지 내용 가져오기 -->
	<select id="getMsgContentByRoom" parameterType="message"
		resultType="message">
		SELECT M.MSGNO, M.MSGROOMNO, M.SENDID, M.RECVID, M.MSGCONTENT,
		M.MSGSENDTIME, M.MSGREADTIME, M.MSGCHK, U.IMAGE
		FROM MESSAGE M LEFT OUTER JOIN MEMBER U
		ON M.SENDID = U.MEMBERID
		<choose>
			<when test="msgRoomNo != 0">
				WHERE MSGROOMNO = #{msgRoomNo}
			</when>
			<otherwise>
				WHERE (RECVID = #{recvId} AND SENDID = #{curId})
				OR (SENDID = #{sendId} AND RECVID = #{curId})
			</otherwise>
		</choose>
	</select>



	<!-- 메세지 읽음 처리 -->
	<update id="updateReadStatus" parameterType="message">
		UPDATE MESSAGE SET MSGCHK=1
		<choose>
			<!-- 기존에 방이 있는 경우 -->
			<when test="msgRoomNo != 0">
				WHERE MSGROOMNO = #{msgRoomNo} and MSGCHK = 0 AND
				RECVID = #{curId}
			</when>
			<!-- 기존에 방이 없는 경우 ??-->
			<otherwise>
				WHERE SENDID = #{recvId} AND MSGCHK = 0 AND RECVID =
				#{curId}
			</otherwise>
		</choose>
	</update>

	<!-- 메세지리스트(왼쪽)에서 메세지 보내기 -->
	<insert id="sendMsgInList" parameterType="message">
		INSERT INTO MESSAGE VALUES(NULL, #{msgRoomNo}, #{sendId}, #{recvId}, 
		#{msgContent}, NOW(), NOW(), 0)
		<!-- <choose> <when test="msgRoomNo != 0"> INSERT INTO MESSAGE VALUES(NULL, 
			#{msgRoomNo}, #{recvId}, #{sendId}, #{content}, NOW(), NOW(), 0) </when> 
			</choose> -->
	</insert>

	<!-- 채팅방번호 최댓값 구하기 -->
	<select id="maxMsgRoomNo" parameterType="message"
		resultType="int">
		SELECT MAX(MSGROOMNO) FROM MESSAGE
	</select>

	<!-- 메세지 이력있는지 검색 -->
	<select id="checkMsgHistory" parameterType="message"
		resultType="int">
		SELECT COUNT(MSGNO) FROM MESSAGE
		WHERE (RECVID = #{recvId}
		AND SENDID = #{sendId})
		OR (RECVID = #{sendId} AND SENDID = #{recvId})
	</select>

	<!-- 기존 메세지 내역의 채팅방번호 가져오기 -->
	<select id="getMsgRoomNo" parameterType="message"
		resultType="int">
		SELECT MSGROOMNO FROM MESSAGE
		WHERE (RECVID = #{recvId}
		AND SENDID = #{sendId})
		OR (RECVID = #{sendId} AND SENDID = #{recvId})
		LIMIT 0,1
	</select>
	
	<!-- navbar에서 보여줄 안읽은 메세지 카운트 -->
	<select id="unReadCntAll" parameterType="string"
		resultType="int">
		SELECT COUNT(MSGNO) FROM MESSAGE
		WHERE RECVID=#{curId}
		AND MSGCHK = 0
	</select>
	
	<!-- 기존에  -->
	



=======
<!-- 해당 Mapper를 MessageDAO로 쓰겠다. 이걸 serviceImpl에서 사용하면 됨-->
<mapper namespace ="MessageDAO">

	<!-- <select id="getList" resultType="com.homegym.biz.message.MessageVO" >
		<![CDATA[
			select * from message where msg_no > 0
		]]>
	</select> -->
	
	<!-- <insert id="insertMessage">
		<selectKey keyProperty="msg_no" order="BEFORE" resultType="long">
			select *from (select max(msg_no)+1 from message) next
		</selectKey>
		insert into message(msg_no,msg_room_no, to_id, from_id, msg_content,msg_chk)
		values (#{msg_no}, #{msg_room_no}, #{to_id}, #{from_id}, #{msg_content}, #{msg_chk})
	</insert> -->
	<!-- <insert id="insertMessage">
		insert into message(msgRoomNo, toId, fromId, msgContent,msgChk)
		values (#{msgRoomNo}, #{toId}, #{fromId}, #{msgContent}, #{msgChk})
	</insert>
	
	<insert id="insertSelectKey">
	
	</insert> -->
	
	<!-- 특정 memberId에 따라서 채팅내용 가져오기
	public ArrayList<MessageVO> getChatListByID(String fromId, String toId, String msgNo) 
	<select id="getChatListById" resultType="com.homegym.biz.message.MessageVO">
		select * from message 
		where ((fromId = #{fromId} and toId =  #{toId}) or (fromId =  #{toId} and toId = #{fromId}))
		and msgNo > 0
		order by #{msgSendDate}
	</select>
	-->
	
	<!--  
	<select id="getChatListByRecent">
		select * from message 
		where ((fromId = #{fromId} and toId =  #{toId}) or (fromId =  #{toId} and toId = #{fromId}))
		and msgNo > (select max(msgNo) - from message)
		order by #{msgSendDate}
	</select>
	-->
	
	<!-- <insert id="submit">
		insert into message 
		values #{fromId}
	</insert> -->
	
	<!-- 메세지 리스트 가져오기 -->
	<select id="getMsgList" resultType="message">
		SELECT * msgNo, msgRoomNo, toId, fromId, msgContent, date_format(msgSendDate, '%Y-%m-%d %H:%i') msgSendTime, msgReadTime, msgChk
		FROM MESSAGE
		WHERE msgNo IN
	</select>
	
	<!-- 메세지 list에서 상대방 profile 가져오기 -->
	
	
>>>>>>> 9e45ed2 (6월 26일 오후 1시 / 홈짐 게시판 페이지 이동 연결 완료)
</mapper> 